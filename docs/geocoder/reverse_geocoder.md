

기미나인의 리버스 지오코딩은 여러 공공데이터를 사용합니다. 사용한 공공데이터의 종류와 처리 방법, 리버스 지오코딩을 구현하는 알고리즘에 대해 알아봅니다.

## 데이터

연속지적도와 건물도형을 사용

## 연속지적도

먼저, 지번 주소를 찾는데 사용하는 연속지적도에 대해 알아보겠습니다.
이 데이터는 브이월드에서 다운로드할 수 있습니다. [여기](https://www.vworld.kr/dtmk/dtmk_ntads_s002.do?dsId=30563)를 클릭하시면 바로 이동할 수 있습니다.
광역시도별로 총 17개의 파일이 있으니, 모두 다운로드해야 합니다. 이 데이터는 EPSG:5186 좌표계로 되어 있습니다.


[TODO: QIGS 그림]

### 도로명주소 건물

다음으로, 도로명 주소를 찾는데 사용하는 도로명주소 건물 데이터에 대해 알아보겠습니다. 
이 데이터는 [business.juso.go.kr](http://business.juso.go.kr)에서 전체분 신청 후 다운로드할 수 있습니다. 
본인 확인, 동의서 체크 등의 과정을 거쳐야 하니, 조금 복잡할 수 있습니다. 
이 데이터도 광역시도별로 총 17개의 파일이 있으니, 모두 다운로드해야 합니다. 

이 데이터는 EPSG:5179 좌표계로 되어 있습니다. 여기서 주의해야 할 점은, 지적도와 좌표계가 다르다는 것입니다.

[TODO: QIGS 그림]

## 알고리즘

리버스 지오코딩은 사용자가 지도를 클릭한 지점의 좌표를 기반으로 도로명주소 건물이나 연속지적도를 검색하고 출력하는 방식으로 동작합니다. 자세한 과정은 다음과 같습니다.

1. 먼저, 사용자가 지도를 클릭한 지점의 좌표를 얻습니다. 이 좌표는 사용자가 클릭한 지점의 정확한 위치를 나타냅니다.

2. 다음으로, 이 좌표를 포함하는 도로명주소 건물을 검색합니다. 이 검색 결과는 사용자가 클릭한 지점에 해당하는 도로명주소 건물을 나타냅니다. 검색 결과가 있으면 이를 출력합니다.

3. 만약 도로명주소 건물이 없으면, 대신 연속지적도를 검색합니다. 이 검색 결과는 사용자가 클릭한 지점에 해당하는 연속지적도를 나타냅니다. 검색 결과가 있으면 이를 출력합니다.

이 알고리즘을 통해 사용자는 지도에서 특정 지점을 클릭하면 그 지점의 주소를 쉽게 알아낼 수 있습니다.

## 검색 알고리즘

### geohash를 활용한 빅데이터 검색

기미나인의 리버스 지오코딩은 연속지적과 도로명주소 건물이라는 빅데이터를 활용합니다. 이 데이터는 각각 39,652,742 건, 6,377,262 건에 달하며, 이런 빅데이터를 효율적으로 검색하기 위해서는 hash 기반의 검색 알고리즘을 사용해야 합니다.

https://geohash.softeng.co/에서는 geohash를 시각적으로 확인할 수 있습니다.

공간데이터를 hash 검색할 때 널리 사용되는 알고리즘이 바로 geohash입니다. Geohash는 사전에 정의된 직사각형 영역에 대한 hash키를 의미하며, 이는 지적 및 건물도형과 1:1로 매칭되지 않습니다. 따라서 지적 및 건물도형과 중첩되는 geohash를 모두 찾아서 보관해야 합니다. 이 과정에서 중복 데이터가 발생할 수 있지만, 빅데이터를 다룰 때는 저장공간에서의 손해보다 속도를 우선시해야 합니다.


지적 및 건물도형은 모두 polygon 형태입니다. 이 polygon에 완전히 포함되는 geohash뿐만 아니라, 겹치는(overlap) geohash까지 저장 대상입니다. 이렇게 저장하는 key와 함께 저장하는 value에는 polygon과 주소 추출을 위한 정보를 모두 저장해야 합니다.

[TODO: 그림 https://github.com/Bonsanto/polygon-geohasher/raw/master/docs/images/geohashed-polygon-1.jpg]


예를 들어, 서울시청의 주소를 알아내야 한다면, 지적으로는 "서울 중구 태평로1가 31 번지", 건물도형으로는 "서울특별시 중구 세종대로 110"이라는 정보를 알 수 있어야 합니다.


### 적절한 geohash level 선택


Geohash는 고정된 자릿수를 가지지 않습니다. 한 자리가 늘어날 때마다 32개의 영역으로 나뉘게 됩니다.

예를 들어, 1자리 Geohash로 key-value 데이터를 만들 경우, 우리나라의 주소는 "y" key 영역과 "v" key 영역에 모두 포함됩니다. 이 경우, hash key는 단 2개인데 반해 value는 4,600만개 이상이므로, hash key의 개수가 너무 적다는 것을 알 수 있습니다.

따라서, 자릿수를 적절히 늘려야 합니다. 예를 들어, 자릿수를 8자까지 늘리면 한국에서의 한 개의 영역 크기는 38.2m x 19.1m 정도가 됩니다. 한자리 더 늘려 9자로 하면 한 변의 길이가 4.77m 정도가 됩니다. 더 좁힐 수도 있지만, 너무 좁히면 처리하기 어려운 규모의 데이터를 만들어야 합니다.

[TODO 그림]


기미나인의 리버스 지오코더는 이러한 고려를 통해 8자리 hash 길이를 사용하고 있습니다.


### 포함 여부 판정 (hash 충돌의 해결)

클릭한 위치의 geohash로 단 한 개의 polygon이 검색되면 매우 간단합니다. 이는 관련 polygon이 단 하나만 있다는 것을 의미하기 때문입니다.
하지만 클릭한 위치가 polygon의 바깥에 있을 가능성이 있으므로, 포함여부를 검사해야 합니다.
point의 polygon내 포함여부를 검사하는 알고리즘은 널리 알려져 있습니다. (대학 알고리즘 수업 중에 들은 기억이 납니다)

클릭한 위치의 geohash로 여러 개의 polygon이 검색되면, 하나씩 포함여부를 검사해서 하나라도 포함되어 있으면 찾은 것입니다.
포함된 것이 두 개일 수도 있습니다. 하나는 지적이고 다른 하나는 건물도형입니다. 이는 지번 주소와 도로명 주소를 모두 갖는 위치라는 것을 의미합니다.

항상 두 주소가 있는 것은 아닙니다. 도로명 주소는 도로와 건물이 있는 경우에만 부여되는 주소이기 때문에, 지번 주소만 있는 경우가 많습니다.

## 데이터 구조

### 연속지적

연속지적 데이터에서는 geohash를 Key로 사용합니다. 그렇다면 Value는 무엇일까요? Value는 주소와 Polygon으로 구성됩니다. Polygon은 텍스트 형식으로 저장하는 것이 가장 효과적이며, 이를 위해 널리 알려진 GIS 표준인 WKT(Well-Known Text) 표현식을 사용합니다.

브이월드에서 다운로드한 연속지적 파일에는 주소 정보가 없습니다. 대신, PNU 코드, 지목, 주번지, 부번지 정보가 포함되어 있습니다.

[TODO: QIGS 그림]

PNU는 Parcel Number의 약자로, 한국어로는 '필지고유번호'라고 할 수 있습니다. 법정동코드 목록은 행정표준관리시스템에서 조회하여 다운로드할 수 있습니다. 다운로드한 파일은 EUC-KR 인코딩이며, 각 필드는 TAB으로 구분됩니다.

법정동코드	법정동명	폐지여부
1100000000	서울특별시	존재
1111000000	서울특별시 종로구	존재
1111010100	서울특별시 종로구 청운동	존재
1111010200	서울특별시 종로구 신교동	존재
1111010300	서울특별시 종로구 궁정동	존재
1111010400	서울특별시 종로구 효자동	존재
1111010500	서울특별시 종로구 창성동	존재
1111010600	서울특별시 종로구 통의동	존재
1111010700	서울특별시 종로구 적선동	존재

PNU는 총 19자로 구성되며, 다음과 같은 형식을 가집니다:

법정동코드(10자) + 필지구분(1자) + 주번지(4자) + 부번지(4자)

필지 구분은 '1'이면 일반, '2'이면 산을 의미합니다. 주번지와 부번지는 0으로 패딩된 4자리 숫자입니다.

예를 들어, '1111010300101230045'라는 PNU가 있다면, 이를 분해하면 다음과 같습니다:

법정동코드: 1111010300
필지구분: 1
주번지: 0123
부번지: 0045

이를 조합하면 "서울특별시 종로구 궁정동 123-45번지"라는 주소를 얻을 수 있습니다.

### 건물 도형

건물 도형 데이터에서도 연속지적 데이터와 마찬가지로 주소와 Polygon이 필요합니다. Polygon의 저장 포맷은 동일합니다.

다운로드 받은 건물 도형 데이터에는 주소 정보가 없습니다. 대신, 다음과 같은 코드 정보가 포함되어 있습니다:

ADR_MNG_NO: 11560132415473400000400004
SIG_CD: 11560
RN_CD: 4154734
BULD_SE_CD: 0
BULD_MNNM: 4
BULD_SLNO: 4
BUL_MAN_NO: 35552
EQB_MAN_SN: 0
EFFECT_DE: 20170427

주소 없이 코드만 들어 있습니다. 하지만 걱정하지 마세요, 우리는 거의 해결책에 다다랐습니다. business.juso.go.kr에서 도로명 데이터를 다운로드 받아서 매칭하면 됩니다. 다운로드 링크는 다음과 같습니다: [도로명 데이터 다운로드](https://business.juso.go.kr/addrlink/attrbDBDwld/attrbDBDwldList.do?cPath=99MD&menu=도로명)

다운받은 데이터는 다음과 같이 구성되어 있습니다:


48250|4805185|00|김해대로2325번길|Gimhae-daero 2325beon-gil|경상남도|김해시|2|||0|김해대로의 시작지점부터 약 23250m(기초번호 2325번) 지점에서 왼쪽으로 분기되는 길|||Gyeongsangnam-do|Gimhae-si||1|46|20091008|
48250|4805187|01|김해대로2371번길|Gimhae-daero 2371beon-gil|경상남도|김해시|1|103|부원동|0|김해대로의 시작지점부터 약 23710m(기초번호 2371번) 지점에서 왼쪽으로 분기되는 길|||Gyeongsangnam-do|Gimhae-si|Buwon-dong|1|30|20091008|
48250|4805188|01|김해대로2385번길|Gimhae-daero 2385beon-gil|경상남도|김해시|1|103|부원동|0|김해대로의 시작지점부터 약 23850m(기초번호 2385번) 지점에서 왼쪽으로 분기되는 길|||Gyeongsangnam-do|Gimhae-si|Buwon-dong|1|48|20091008|
48250|4805189|00|김해대로2415번길|Gimhae-daero 2415beon-gil|경상남도|김해시|2|||0|김해대로의 시작지점부터 약 24150m(기초번호 2415번) 지점에서 왼쪽으로 분기되는 길|||Gyeongsangnam-do|Gimhae-si||1|16|20091008|
48250|4805190|00|김해대로2431번길|Gimhae-daero 2431beon-gil|경상남도|김해시|2|||0|김해대로의 시작지점부터 약 24310m(기초번호 2431번) 지점에서 왼쪽으로 분기되는 길|||Gyeongsangnam-do|Gimhae-si||1|34|20091008|

이 중 첫번째와 두 번째 컬럼이 시군구코드와 도로명번호입니다. 이들은 건물 도형 데이터의 SIG_CD, RN_CD와 매칭됩니다. 총 21개의 컬럼이 있지만, 현재 중요한 컬럼은 다음 5개뿐입니다:

1. 시군구코드
2. 도로명번호
4. 도로명
6. 시도명
7. 시군구명


전체 컬럼 설명:
*   1    시군구코드     5           문자 PK1
*   2    도로명번호     7           문자 도로명코드 : 시군구코드(5) + 도로명번호(7)
    3    읍면동일련번호 2           문자 PK2
*   4    도로명         80          문자
    5    영문도로명     80          문자
*   6    시도명         40          문자
*   7    시군구명       40          문자
    8    읍면동구분     1           문자 0: 읍면, 1:동, 2:미부여
    9    읍면동코드     3           문자 법정동기준읍면동코드
    10   읍면동명       40          문자
    11   사용여부       1           문자 0: 사용, 1: 미사용
    12   부여사유       254         문자
    13   변경이력사유   1           문자     {0: 도로명변경, 1: 도로명폐지, 2: 시도시군구변경, 3: 읍면동변경, 4: 영문도로명변경, 9: 기타}
    14   변경이력정보   14           문자 도로명코드(12)+ 읍면동일련번호(2)     ※ 신규정보일경우“신규”로표시
    15   영문시도명     40           문자
    16   영문시군구명   40           문자
    17   영문읍면동명   40           문자
    18   도로구간의 시작 지점 기초번호  10 문자
    19   도로구간 끝지점 기초번호       10 문자
    20   효력발생일     8           문자 효력발생일자(YYYYMMDD)
    21   말소일자       8           문자 말소일자(YYYYMMDD)

건물 도형 데이터의 ADR_MNG_NO 코드는 총 26자로 구성되어 있습니다. 처음 12자는 시군구코드와 도로명번호를 연결한 것이며, 다음 1자는 지하 여부를 나타냅니다(0은 지상, 1은 지하, 2는 공중). 나머지 10자는 5자씩 건물본번과 건물부번을 나타냅니다.

예를 들어, '48250480519010012300045'라는 ADR_MNG_NO 코드가 있다면, 이를 분해하면 다음과 같습니다:

시군구코드: 48250
도로명번호: 4805190
지하 여부: 1
건물본번: 00123
건물부번: 00045

이를 조합하면 "경상남도 김해시 김해대로2431번길 지상 123-45"라는 주소를 얻을 수 있습니다. 일반적으로 지상은 표기하지 않으므로, 최종적으로 "경상남도 김해시 김해대로2431번길 123-45"가 이 지점의 주소가 됩니다.

긴 포스트 마칩니다.
